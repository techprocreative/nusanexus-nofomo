# NusaNexus NoFOMO - Rate Limiting Configuration
# Protection against DDoS and abuse

# Rate limiting zones
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=login:10m rate=1r/s;
limit_req_zone $binary_remote_addr zone=auth:10m rate=3r/s;
limit_req_zone $binary_remote_addr zone=trading:10m rate=5r/s;
limit_req_zone $binary_remote_addr zone=ai_requests:10m rate=2r/s;

# Connection limiting
limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;
limit_conn_zone $server_name zone=conn_limit_per_server:10m;

# API rate limiting
location /api/v1/ {
    limit_req zone=api burst=20 nodelay;
    limit_conn conn_limit_per_ip 20;
    
    # CORS headers
    add_header Access-Control-Allow-Origin "$http_origin" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization" always;
    add_header Access-Control-Expose-Headers "Content-Length,Content-Range" always;
    
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Max-Age 1728000;
        add_header Content-Type 'text/plain; charset=utf-8';
        add_header Content-Length 0;
        return 204;
    }
}

# Authentication endpoints - strict rate limiting
location ~ ^/api/v1/(auth|login|register|reset-password) {
    limit_req zone=login burst=5 nodelay;
    limit_conn conn_limit_per_ip 5;
    
    # Additional security for auth endpoints
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
    
    # Log authentication attempts
    access_log /var/log/nginx/auth.log;
    error_log /var/log/nginx/auth_error.log;
}

# Trading endpoints - moderate rate limiting
location ~ ^/api/v1/(trading|bots|orders) {
    limit_req zone=trading burst=10 nodelay;
    limit_conn conn_limit_per_ip 10;
    
    # Require authentication
    if ($http_authorization ~ "") {
        return 401;
    }
}

# AI endpoints - strict rate limiting
location ~ ^/api/v1/(ai|strategy|backtest) {
    limit_req zone=ai_requests burst=3 nodelay;
    limit_conn conn_limit_per_ip 3;
    
    # Require higher authentication level
    if ($http_authorization ~ "") {
        return 401;
    }
    
    # Log AI requests for monitoring
    access_log /var/log/nginx/ai.log;
}

# WebSocket endpoints
location /ws/ {
    limit_conn conn_limit_per_ip 5;
    
    # WebSocket specific headers
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    
    # Rate limiting for WebSocket connections
    if ($http_upgrade != "websocket") {
        return 400;
    }
}

# Static files - relaxed rate limiting
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    limit_req zone=api burst=50 nodelay;
    expires 1y;
    add_header Cache-Control "public, immutable";
    access_log off;
}

# Health check endpoint - no rate limiting
location /health {
    access_log off;
    return 200 "healthy\n";
    add_header Content-Type text/plain;
}

# Deny access to sensitive files
location ~ /\. {
    deny all;
    access_log off;
    log_not_found off;
}

location ~ \.(env|config|ini|log|conf)$ {
    deny all;
    access_log off;
    log_not_found off;
}

location ~ \.(htaccess|htpasswd)$ {
    deny all;
    access_log off;
    log_not_found off;
}

# Additional protection
location /admin/ {
    # IP whitelist (add your IP ranges)
    allow 192.168.1.0/24;
    allow 10.0.0.0/8;
    allow 172.16.0.0/12;
    deny all;
    
    # Basic auth for extra security
    auth_basic "Admin Area";
    auth_basic_user_file /etc/nginx/.htpasswd;
}

# Bot protection
if ($http_user_agent ~* "bot|crawler|spider|scanner") {
    limit_req zone=api burst=5 nodelay;
    add_header X-Bot-Detected "true";
}