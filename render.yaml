# NusaNexus NoFOMO - Render Deployment Configuration
# This configuration deploys the complete platform to Render.com

services:
  # Backend API Service
  - type: web
    name: nusafx-backend
    runtime: python
    plan: free
    buildCommand: cd backend && pip install -r requirements.txt
    startCommand: cd backend && uvicorn main:app --host 0.0.0.0 --port $PORT
    pythonVersion: "3.11"
    envVars:
      - key: APP_NAME
        value: NusaNexus NoFOMO Backend
      - key: DEBUG
        value: "false"
      - key: SECRET_KEY
        value: '${SECRET_KEY}'
      - key: ALLOWED_ORIGINS
        value: '${ALLOWED_ORIGINS}'
      - key: ALLOWED_HOSTS
        value: '${ALLOWED_HOSTS}'
      - key: DATABASE_URL
        value: postgresql://nusafx_user:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/nusafxtrade
      - key: REDIS_URL
        value: '${REDIS_URL}'
      - key: SUPABASE_URL
        value: '${SUPABASE_URL}'
      - key: SUPABASE_KEY
        value: '${SUPABASE_KEY}'
      - key: SUPABASE_SERVICE_ROLE_KEY
        value: '${SUPABASE_SERVICE_ROLE_KEY}'
      - key: OPENROUTER_API_KEY
        value: '${OPENROUTER_API_KEY}'
      - key: OPENROUTER_BASE_URL
        value: 'https://openrouter.ai/api/v1'
      - key: BINANCE_API_URL
        value: 'https://api.binance.com'
      - key: BYBIT_API_URL
        value: 'https://api.bybit.com'
      - key: LOG_LEVEL
        value: INFO
      - key: SENTRY_DSN
        value: '${SENTRY_DSN}'
    healthCheckPath: /health

  # Frontend Web Service
  - type: web
    name: nusafx-frontend
    runtime: node
    plan: free
    buildCommand: cd frontend && npm ci && npm run build
    startCommand: cd frontend && npm start
    envVars:
      - key: NEXT_PUBLIC_SUPABASE_URL
        value: '${SUPABASE_URL}'
      - key: NEXT_PUBLIC_SUPABASE_ANON_KEY
        value: '${SUPABASE_KEY}'
      - key: NEXT_PUBLIC_API_URL
        value: 'https://nusafx-backend.onrender.com/api/v1'
      - key: NODE_ENV
        value: production
    healthCheckPath: /

  # ⚠️ WORKERS NOT AVAILABLE ON FREE TIER ⚠️
  # Background workers require Render Starter plan ($7/month per worker)
  # Uncomment and deploy these manually when ready to upgrade
  # For now, MVP can function with just backend + frontend
  
  # # AI Engine Worker (REQUIRES PAID PLAN)
  # - type: worker
  #   name: nusafx-ai-engine
  #   runtime: python
  #   plan: starter  # Minimum plan required for workers
  #   pythonVersion: "3.11"
  #   buildCommand: cd ai_engine && pip install -r requirements.txt
  #   startCommand: cd ai_engine && python ai_engine_core.py
  #   envVars:
  #     - key: OPENROUTER_API_KEY
  #       value: '${OPENROUTER_API_KEY}'
  #     - key: OPENROUTER_BASE_URL
  #       value: 'https://openrouter.ai/api/v1'
  #     - key: OPENROUTER_MODEL
  #       value: 'anthropic/claude-3-sonnet'
  #     - key: SUPABASE_URL
  #       value: '${SUPABASE_URL}'
  #     - key: SUPABASE_SERVICE_ROLE_KEY
  #       value: '${SUPABASE_SERVICE_ROLE_KEY}'
  #     - key: REDIS_URL
  #       value: '${REDIS_URL}'
  #     - key: LOG_LEVEL
  #       value: INFO

  # # Bot Runner Worker (REQUIRES PAID PLAN)
  # - type: worker
  #   name: nusafx-bot-runner
  #   runtime: python
  #   plan: starter  # Minimum plan required for workers
  #   pythonVersion: "3.11"
  #   buildCommand: cd bot-runner && pip install -r requirements.txt
  #   startCommand: cd bot-runner && python worker.py
  #   envVars:
  #     - key: REDIS_URL
  #       value: '${REDIS_URL}'
  #     - key: SUPABASE_URL
  #       value: '${SUPABASE_URL}'
  #     - key: SUPABASE_SERVICE_ROLE_KEY
  #       value: '${SUPABASE_SERVICE_ROLE_KEY}'
  #     - key: BINANCE_API_URL
  #       value: 'https://api.binance.com'
  #     - key: BYBIT_API_URL
  #       value: 'https://api.bybit.com'
  #     - key: LOG_LEVEL
  #       value: INFO

# IMPORTANT: Configure these environment variables in Render Dashboard:
#
# Required Secrets (Add in Render Environment):
# - SECRET_KEY: Generate with: openssl rand -base64 32
# - SUPABASE_URL: From your Supabase project settings
# - SUPABASE_KEY: Supabase anon/public key
# - SUPABASE_SERVICE_ROLE_KEY: Supabase service role key (keep secure!)
# - OPENROUTER_API_KEY: From OpenRouter.ai dashboard
# - REDIS_URL: From Upstash Redis (FREE TIER AVAILABLE!)
#   Get free Redis at: https://console.upstash.com/
#   Format: rediss://default:PASSWORD@HOST:PORT
#
# Optional Configuration:
# - ALLOWED_ORIGINS: Comma-separated list (e.g., "https://frontend.onrender.com,https://yourdomain.com")
# - ALLOWED_HOSTS: Comma-separated list (e.g., "*.onrender.com,*.yourdomain.com")
# - SENTRY_DSN: For error monitoring (optional)
# - POSTGRES_PASSWORD: If using managed PostgreSQL (not needed for Supabase)
#
# FREE TIER NOTES:
# - Backend and Frontend use FREE tier (750 hours/month each)
# - Services spin down after 15 minutes of inactivity (~30-50s cold start)
# - Database: Supabase (free tier)
# - Redis: Upstash (free tier - 10,000 commands/day)
# 
# ⚠️ WORKER SERVICES NOT AVAILABLE ON FREE TIER:
# - Background workers (AI Engine, Bot Runner) require Starter plan ($7/month each)
# - MVP can function with just Backend + Frontend for testing/demo
# - To enable workers: Uncomment them above and deploy manually as separate services
# - Workers are needed for: AI strategy generation, automated bot execution
#
# PYTHON VERSION:
# - Using Python 3.11 for compatibility with pandas 2.1.4
# - Python 3.13+ not yet supported by all dependencies
#
# For production use, upgrade services to Starter plans ($7/month per service)
